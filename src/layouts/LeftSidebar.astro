---
import Base from "@/layouts/Base.astro";
import { getDocsMenu, flattenTree } from "@/lib/docs/menu";

const { pathname } = Astro.url;
const menu = getDocsMenu();

const isActive = (u: string) => pathname === u || pathname === `${u}/`;

// Aplano para prev/next (ya filtrado dev-only vía helper)
const flat = flattenTree(menu);
const idx = flat.findIndex((x) => x.url && isActive(x.url!));
const prev = idx > 0 ? flat[idx - 1] : null;
const next = idx >= 0 && idx < flat.length - 1 ? flat[idx + 1] : null;
---

<Base>
  <section class="section pt-6">
    <div class="container">
      <div class="grid grid-cols-1 gap-8 md:grid-cols-[260px_1fr]">
        <aside class="md:sticky md:top-20 h-max">
          <nav class="space-y-1">
            {menu.map((n) => (
              <div>
                <a
                  href={n.url ?? "#"}
                  class={`block rounded px-3 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 ${
                    n.url && isActive(n.url) ? "font-semibold bg-black/5 dark:bg-white/10" : ""
                  }`}
                >
                  {n.name}
                </a>

                {n.children && (
                  <div class="ml-3 mt-1 space-y-1">
                    {n.children.map((c) => (
                      <a
                        href={c.url ?? "#"}
                        class={`block rounded px-3 py-1.5 text-sm opacity-90 hover:bg-black/5 dark:hover:bg-white/10 ${
                          c.url && isActive(c.url) ? "font-semibold bg-black/5 dark:bg-white/10" : ""
                        }`}
                      >
                        {c.name}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </nav>
        </aside>

        <main class="min-w-0">
          <slot />

          <div class="mt-10 flex justify-between text-sm">
            <div>
              {prev && <a class="hover:underline" href={prev.url!}>← {prev.name}</a>}
            </div>
            <div>
              {next && <a class="hover:underline" href={next.url!}>{next.name} →</a>}
            </div>
          </div>
        </main>
      </div>
    </div>
  </section>
</Base>
