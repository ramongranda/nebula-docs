---
// RUTA DINÁMICA DOCS (Astro 5 compatible)
// - getStaticPaths devuelve { slug: string | undefined }
// - filtra dev-only en producción (_dev/ o devOnly: true)
// - carga MD/MDX correspondiente

import LeftSidebar from "@/layouts/LeftSidebar.astro";

// 1) Generar rutas estáticas
export async function getStaticPaths() {
  const isProd = import.meta.env.PROD;
  const mods = import.meta.glob("../../content/docs/**/*.{md,mdx}", { eager: true });

  const paths = Object.entries(mods).flatMap(([k, modAny]) => {
    const mod = modAny as any;
    const fm = mod?.frontmatter ?? {};

    // rel = ruta relativa dentro de content/docs, sin extensión
    let rel = k.split("content/docs/")[1].replace(/\\/g, "/").replace(/\.(md|mdx)$/i, "");

    // index.md -> carpeta
    if (rel.endsWith("/index")) rel = rel.slice(0, -("/index".length));

    // dev-only?
    const devOnly = fm.devOnly === true || rel.startsWith("_dev/");
    if (isProd && devOnly) return [];

    // Para [...slug], Astro 5 quiere string o undefined
    const slug = rel || undefined; // undefined => /docs/

    return [{ params: { slug } }];
  });

  return paths;
}

// 2) Resolver qué MD mostrar para esta petición
const slugParam = Astro.params.slug as string | undefined; // viene como string con "/" o undefined
const rel = slugParam && slugParam.length ? slugParam : "index";

const mods = import.meta.glob("../../content/docs/**/*.{md,mdx}");
const tryPaths = [
  `../../content/docs/${rel}.md`,
  `../../content/docs/${rel}.mdx`,
  `../../content/docs/${rel}/index.md`,
  `../../content/docs/${rel}/index.mdx`,
];

let Content, frontmatter;
for (const p of tryPaths) {
  if (p in mods) {
    const mod: any = await mods[p]();
    Content = mod.default;
    frontmatter = mod.frontmatter ?? {};
    break;
  }
}

if (!Content) return Astro.redirect("/404");

// 3) Bloquear dev-only en producción (cinturón + tirantes)
const isDev = import.meta.env.DEV;
const isDevOnly = frontmatter?.devOnly === true || rel.startsWith("_dev/");
if (!isDev && isDevOnly) return Astro.redirect("/404");
---

<LeftSidebar>
  <article class="prose dark:prose-invert max-w-none">
    <Content />
  </article>
</LeftSidebar>
