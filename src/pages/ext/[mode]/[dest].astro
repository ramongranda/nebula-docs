---
export const prerender = false; // dynamic SSR route for client-only wrapper
// Dynamic external wrapper: /ext/<mode>/<dest>
// <dest> is base64url-encoded external URL; <mode> is same|new|embed
const params = Astro.params || {};
const modeParam = (params.mode || 'same').toString().toLowerCase();
const normalize = (m) => (m === 'embed' || m === 'new' || m === 'same') ? m : 'same';
const fromBase64Url = (s) => {
  try {
    const pad = s.length % 4 === 0 ? '' : '='.repeat(4 - (s.length % 4));
    const b64 = s.replace(/-/g, '+').replace(/_/g, '/') + pad;
    return Buffer.from(b64, 'base64').toString('utf8');
  } catch {
    return '';
  }
};
const isHttp = (u) => /^https?:\/\//i.test(u);

const destParam = (params.dest || '').toString();
const targetUrl = fromBase64Url(destParam).trim();
const mode = normalize(modeParam);
const valid = !!targetUrl && isHttp(targetUrl);

if (valid && mode === 'new') {
  const to = `/ext-new?u=${encodeURIComponent(targetUrl)}`;
  return Astro.redirect(to);
}
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>External</title>
  </head>
  <body style="margin:0; padding:0;">
    {valid ? (
      mode === 'embed' ? (
        <div style="height:100vh; display:flex; flex-direction:column;">
          <div style="padding:0.75rem 1rem; font: 600 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;">
            Loading: <a href={targetUrl} rel="noopener external" target="_blank">{targetUrl}</a>
          </div>
          <iframe src={targetUrl} style="border:0; flex:1 1 auto; width:100%;"></iframe>
        </div>
      ) : (
        <div style="padding:1rem; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;">
          <div id="ext-data" data-url={targetUrl}></div>
          <p>Redirectingâ€¦ <a href={targetUrl} rel="noopener external">Continue</a></p>
          <script is:inline>
            (function(){
              var el = document.getElementById('ext-data');
              if(!el) return;
              var u = el.dataset.url || '';
              if(!u) return;
              window.location.replace(u);
            })();
          </script>
        </div>
      )
    ) : (
      <div style="padding:1rem; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;">
        <p>Invalid external link.</p>
      </div>
    )}
  </body>
</html>

